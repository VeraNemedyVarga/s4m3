<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>WS test</title>
</head>
<body>
  <!-- <pre id="content"></pre> -->
  <main id="main">
    <p id="gameover">Game Over</p>
    <div class="heading">
        <span>Points: </span>
        <span id="points"></span>
    </div>
    <canvas id="canvas" width="1000" height="1000"></canvas>
    <div class="buttons">
      <button id="restart">Restart Board</button>
      <button id="newgame">New Game</button>
    </div>
  </main>
<script>
  const canvas = document.getElementById("canvas");
  const ctx = canvas.getContext("2d");
  const width = 20;
  const height = 20;
  const tilewidth = 30;

  const points = document.getElementById("points");
  const gameOver = document.getElementById("gameover");

  const restart = document.getElementById("restart");
  const newgame = document.getElementById("newgame");

  const autoPlayOn = false;

  restart.addEventListener("click", e => {
    hit(0, 0, true);
  })

  newgame.addEventListener("click", e => {
    hit(0, 0, false, true);
  })

  var ws = new WebSocket(`ws://${window.location.host}/ws`);
  ws.onopen = function() {
    console.log("open");
  };
  ws.onmessage = function(e) {
    let data = JSON.parse(e.data);
    setUpCanvas(data.board);
    points.textContent = data.points;
    if(data.gameOver) {
      gameOver.setAttribute("visibility", "visible");
    } else {
      gameOver.setAttribute("visibility", "hidden");
    }
  };
  ws.onclose = function() {
    console.log("close");
  };
  
  var hit = (x, y, restart = false, newGame = false) => {
    ws.send(JSON.stringify({x, y, restart, new: newGame}));
  };
  
  setUpCanvas = function(board) {
    ctx.canvas.width = tilewidth * width;
    ctx.canvas.height = tilewidth * height;
    ctx.strokeStyle = "lightgrey";
    for(let i = 0; i < width; i++) {
      for(let j = 0; j < height; j++) {
        ctx.strokeRect((i * tilewidth), (j * tilewidth), tilewidth, tilewidth);
        ctx.fillStyle = board.tiles[j][i].Color;
        ctx.fillRect((i * tilewidth), (j * tilewidth), tilewidth, tilewidth);
      }
    }

    if(autoPlayOn) {
      // console.log(canvas.getBoundingClientRect());
      let x = Math.floor(Math.random() * 20);
      let y = Math.floor(Math.random() * 20);
      if(board.tiles[x][y].Sign !== " ") {
        console.log("x, y", x, y);
        hit(x, y);
      }
    }
    goThroughBaseRow(board)
  }
  
  handleClick = function(e) {
    console.log(e)
    const canvasOffsetX = this.offsetLeft - this.scrollLeft;
    const canvasOffsetY = this.offsetTop - this.scrollTop;
    
    const x = event.pageX - canvasOffsetX;
    const y = event.pageY - canvasOffsetY;
    console.log("canvasOffsetX", canvasOffsetX, "canvasOffsetY", canvasOffsetY);
    
    let nearestRectX = Math.floor(x / tilewidth);
    let nearestRectY = Math.floor(y / tilewidth);
    console.log("hit target", nearestRectX, nearestRectY, this);
    hit(nearestRectX, nearestRectY);
  }
  canvas.addEventListener("click", handleClick);
  
  autoPlay = function(board) {
    for(let i = width; i > 0; i--) {
      for(let j = height; j > 0 ; j--) {
        board.tiles[j][i]
      }
    }
  }
  
  goThroughBaseRow = function(board) {
    let scores = []
    for(let i = 1; i < board.width - 1; i++) {
      let currentTile ={
        x: i,
        y: height-1
      };
      let score = getNeighbor(board, height-1, i);
      scores.push({
        score,
        currentTile
      });
    }
    scores.sort((a, b) => b.score - a.score);
    console.log(scores[0].currentTile.x, scores[0].currentTile.y, "score is ", scores[0].score)
    hit(scores[0].currentTile.x, scores[0].currentTile.y);
  }

  getNeighbor = function(board, y, x) {
    let neighbors
    if (x >= 1 && x <= 18) {
      neighbors = [board.tiles[y-1][x], board.tiles[y-1][x-1], board.tiles[y][x-1], board.tiles[y][x+1], board.tiles[y-1][x+1]];
    } else if (x <= 1) {
      neighbors = [board.tiles[y][x-1], board.tiles[y][x+1], board.tiles[y-1][x+1]];
    } else {
      neighbors = [board.tiles[y-1][x], board.tiles[y][x-1],  board.tiles[y-1][x-1]];
    }
    let score = addScore(neighbors, board.tiles[y][x]);
    if(score < 2) {
      score = 0
    }
    return score;
  }

  addScore = function(neighbors, current) {
    console.log("current ", current);
    let scores = neighbors.filter(tile => {
      console.log("tile ", tile);
      if(tile.Sign == current.Sign && tile.Sign !== " ") {
        return tile;
      }
    });
    console.log(scores);
    return scores.length;
  }

</script>
</body>
<link rel="stylesheet" href="style.css" type="text/css">
</html>
